<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DerivaIntegra</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <!-- Nerdamer.js for symbolic math calculations -->
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/nerdamer.core.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Calculus.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Algebra.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Extra.js" defer></script>
    
    <!-- MathQuill for the visual editor -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.js"></script>

    <!-- Tesseract.js for OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js' defer></script>
    
    <!-- KaTeX for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos da tela de carregamento */
        #loading-screen { position: fixed; inset: 0; background-color: #f3f4f6; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 50; transition: opacity 0.5s ease-out; }
        #loading-screen .content { text-align: center; }
        #loading-screen h1 { font-size: 3rem; font-weight: 700; color: #1f2937; }
        #loading-screen #progress-bar-container { width: 16rem; background-color: #e5e7eb; border-radius: 9999px; height: 0.625rem; margin-top: 2rem; overflow: hidden; }
        #loading-screen .progress-bar-inner { background-color: #2563eb; height: 100%; border-radius: 9999px; animation: loading-animation 2s ease-in-out infinite; }
        #loading-screen #loading-text { color: #6b7280; margin-top: 1rem; }
        @keyframes loading-animation { 0% { width: 0%; } 50% { width: 100%; } 100% { width: 0%; } }

        /* Estilos gerais */
        body { font-family: 'Inter', sans-serif; }
        .btn-hover:hover { background-color: #1d4ed8; }
        .keyboard-btn { @apply bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition-all duration-150 ease-in-out flex items-center justify-center dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600; }
        #resultOutput img { max-width: 100%; height: auto; background-color: white; padding: 0.5rem; border-radius: 0.5rem; }
        #equation-editor { @apply w-full bg-white border border-gray-300 rounded-lg min-h-[70px] p-3 text-2xl dark:bg-gray-800 dark:border-gray-600; }
        .dark #equation-editor { color: white; }
        #equation-editor .mq-editable-field .mq-cursor { border-left: 2px solid #3b82f6; }
        
        /* Transições de View */
        #calculator-view, #history-view, #options-view { transition: opacity 0.6s ease-in-out; }

        /* Estilos do Modal de Scan */
        #scan-modal.hidden { display: none; }
        #scan-modal-content { transform: scale(0.95); opacity: 0; transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
        #scan-modal:not(.hidden) #scan-modal-content { transform: scale(1); opacity: 1; }
        #image-preview, #camera-stream { max-height: 40vh; width: 100%; object-fit: contain; }
        .tab-btn.active { @apply bg-blue-600 text-white; }
        .tab-btn { @apply w-full text-center p-3 rounded-lg font-semibold bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 transition-colors; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* KaTeX Cursom Font Size */
        #function-display-area .katex-display {
            font-size: 1.35rem;
            margin: 0;
        }
        /* NOVO: Esconde o editor MathQuill mas o mantém funcional */
        #equation-editor-wrapper {
            position: absolute;
            opacity: 0;
            pointer-events: none;
            height: 0;
            width: 0;
            overflow: hidden;
        }
        /* NOVOS Estilos para a Navegação Inferior */
        .nav-btn {
            /* Adicionado text-center para os nomes, e cor dark mais clara */
             @apply flex flex-col items-center justify-center gap-0 py-1 px-3 rounded-xl text-gray-600 dark:text-gray-100 transition-all duration-200 flex-1 text-center leading-tight;
        }
        .nav-btn svg {
             /* Adicionada regra explícita para cor do SVG */
            @apply text-gray-600 dark:text-gray-100;
        }
        .nav-btn.active {
            @apply text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/50;
        }
        .nav-btn.active svg {
            /* Adicionada regra explícita para cor do SVG ativo */
            @apply text-blue-600 dark:text-blue-400;
            stroke-width: 2.5;
        }
        /* NOVOS Estilos para a View de Histórico */
        #history-list-container .history-card {
            @apply bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 space-y-3;
        }
        #history-list-container .history-card-header {
            @apply flex justify-between items-start gap-3;
        }
        #history-list-container .history-card-icon {
            @apply w-10 h-10 rounded-lg flex items-center justify-center shrink-0 bg-blue-50 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400;
        }
        #history-list-container .history-card-fn {
            @apply flex-1 min-w-0 overflow-x-auto;
        }
        #history-list-container .history-card-fn .katex-display {
            margin: 0; /* Corrige margem do KaTeX */
        }
        #history-list-container .history-card-badges {
            @apply flex flex-wrap gap-1.5;
        }
        #history-list-container .history-card-result {
            @apply p-3 rounded-lg bg-gray-50 dark:bg-gray-700/50 overflow-x-auto;
        }
        #history-list-container .history-card-result img {
            max-width: 100%;
            height: auto;
            background-color: transparent; /* Imagem já tem fundo branco */
            padding: 0;
            border-radius: 0;
            margin: 0 auto; /* Centraliza a imagem do resultado */
        }
        .filter-btn {
            @apply p-2 px-4 rounded-lg text-sm font-semibold transition-colors bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200;
        }
        .filter-btn.active {
            @apply bg-blue-600 text-white;
        }

    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 pb-20"> <!-- Classes de centralização removidas, pb-20 adicionado -->

    <!-- Tela de Carregamento -->
    <div id="loading-screen">
        <div class="content">
            <h1>DerivaIntegra</h1>
            <div id="progress-bar-container"><div class="progress-bar-inner"></div></div>
            <p id="loading-text">Carregando as bibliotecas...</p>
        </div>
    </div>

    <!-- NOVO Cabeçalho Fixo (Adaptado do Layout.js) -->
    <header class="fixed top-0 left-0 right-0 z-40 backdrop-blur-lg border-b bg-white/90 dark:bg-gray-800/90 border-gray-200 dark:border-gray-700">
        <div class="relative flex justify-between items-center p-4 h-16">
            <!-- Botão de Câmera -->
            <button id="scan-btn-header" class="text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
            
            <!-- Título do App (Centralizado) -->
            <div class="flex items-center gap-2 absolute left-1/2 -translate-x-1/2">
                <div class="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold text-white bg-gradient-to-r from-blue-600 to-green-500">
                  D∫
                </div>
                <h1 class="font-bold text-lg text-gray-800 dark:text-white">
                  DerivaIntegra
                </h1>
            </div>

            <!-- Botão de Menu (REMOVIDO) -->
        </div>
    </header>

    <!-- Container Principal do App (Classes de layout removidas, pt-16 adicionado) -->
    <div id="app-container" class="pt-16" style="display: none;">
        
        <!-- View da Calculadora (Classes de padding adicionadas p-4) -->
        <div id="calculator-view" class="space-y-6 p-4">

            <!-- Container do Cabeçalho ANTIGO REMOVIDO -->
            
            <!-- NOVO Display de Função -->
            <div id="function-display-area" class="bg-gray-50 dark:bg-gray-700/50 border-l-4 border-blue-500 dark:border-blue-400 p-4 rounded-lg min-h-[70px] flex items-center justify-center overflow-x-auto cursor-text">
                <span id="function-display-text" class="text-gray-600 dark:text-gray-400 text-lg"></span>
            </div>
            
            <!-- BLOCO DE RESULTADO MOVIDO PARA CÁ -->
            <div id="resultArea" class="mt-4"> <!-- Estilos de borda e padding removidos -->
                <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Resultado:</h2>
                <div id="resultOutput" class="mt-2 text-center bg-gray-50 dark:bg-gray-700 p-4 rounded-lg min-h-[90px] flex items-center justify-center text-lg">
                     <p class="text-gray-500 dark:text-gray-400">O resultado aparecerá aqui.</p>
                </div>
            </div>
            <!-- FIM DO BLOCO MOVIDO -->

            <div class="space-y-4">
                <!-- MOVIDO PARA CIMA E ESCONDIDO -->
                <div id="equation-editor-wrapper">
                    <!-- Label removido -->
                    <span id="equation-editor"></span>
                </div>

                <!-- BLOCO DA OPERAÇÃO (AGORA EM SEGUNDO) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Selecione a Operação:</label>
                    <div class="flex gap-4">
                        <label for="derivada" class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:dark:bg-blue-900/50 has-[:checked]:border-blue-500">
                            <input type="radio" id="derivada" name="operation" value="derivative" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                            <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-100">Derivada</span>
                        </label>
                        <label for="integral" class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:dark:bg-blue-900/50 has-[:checked]:border-blue-500">
                            <input type="radio" id="integral" name="operation" value="integral" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-100">Integral</span>
                        </label>
                    </div>
                </div>
                <div id="integralLimits" class="hidden space-y-4 pt-4">
                     <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Limites de Integração (opcional):</label>
                     <div class="flex items-center gap-4">
                        <input type="text" id="limitA" placeholder="Limite a" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <input type="text" id="limitB" placeholder="Limite b" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                     </div>
                </div>
                <!-- O EDITOR DE FUNÇÃO ESTAVA AQUI (AGORA ESTÁ ACIMA) -->
                
                <div class="pt-4 space-y-2 dark:bg-gray-100 dark:p-4 dark:rounded-lg">
                    <div id="mathKeyboard" class="grid grid-cols-5 gap-2">
                        <button class="keyboard-btn bg-green-200" data-cmd="sin">sin</button><button class="keyboard-btn bg-green-200" data-cmd="cos">cos</button><button class="keyboard-btn bg-green-200" data-cmd="tan">tan</button><button class="keyboard-btn bg-gray-300" data-cmd="^">n²</button><button class="keyboard-btn bg-gray-300 variable-x" data-write="x">x</button>
                        <button class="keyboard-btn bg-white" data-write="7">7</button><button class="keyboard-btn bg-white" data-write="8">8</button><button class="keyboard-btn bg-white" data-write="9">9</button><button class="keyboard-btn bg-gray-300" data-write="(">(</button><button class="keyboard-btn bg-gray-300" data-write=")">)</button>
                        <button class="keyboard-btn bg-white" data-write="4">4</button><button class="keyboard-btn bg-white" data-write="5">5</button><button class="keyboard-btn bg-white" data-write="6">6</button><button class="keyboard-btn bg-gray-300" data-write="+">+</button><button class="keyboard-btn bg-gray-300" data-write="-">-</button>
                        <button class="keyboard-btn bg-white" data-write="1">1</button><button class="keyboard-btn bg-white" data-write="2">2</button><button class="keyboard-btn bg-white" data-write="3">3</button><button class="keyboard-btn bg-gray-300" data-write="\cdot ">×</button><button class="keyboard-btn bg-gray-300 text-2xl" data-cmd="/">/</button>
                        <button class="keyboard-btn bg-white" data-write="\pi">π</button><button class="keyboard-btn bg-white" data-write="0">0</button><button class="keyboard-btn bg-white" data-write=".">.</button><button class="keyboard-btn bg-gray-300 text-2xl" data-action="keystroke" data-value="Left">←</button><button class="keyboard-btn bg-gray-300 text-2xl" data-action="keystroke" data-value="Right">→</button>
                        <button class="keyboard-btn" data-cmd="ln">ln</button><button class="keyboard-btn" data-cmd="|">|x|</button><button class="keyboard-btn bg-white" data-cmd="\sqrt">√</button><button class="keyboard-btn bg-red-200" data-action="keystroke" data-value="Backspace">Apagar</button><button class="keyboard-btn bg-red-200" data-action="clear">Limpar</button>
                    </div>
                </div>
                <button id="calculateBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg btn-hover transition-colors duration-300 mt-4">Calcular</button>
            </div>
            
            <!-- Bloco de Resultado removido daqui -->

        </div>

        <!-- View do Tutor RENOMEADA E REFEITA para View de Histórico -->
        <div id="history-view" class="hidden min-h-screen p-4 pt-4"> <!-- Padding-top removido para se alinhar ao pt-16 do container -->
            
            <!-- Barra de Busca (inspirado em historico.js) -->
            <div class="relative mb-4">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <input type="search" id="history-search-input" placeholder="Buscar função..." class="w-full h-12 pl-10 pr-4 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
            </div>

            <!-- Botões de Filtro (inspirado em historico.js) -->
            <div class="flex gap-2 mb-4">
                <button id="filter-all" class="filter-btn active">Todos</button>
                <button id="filter-derivative" class="filter-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="inline h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                    </svg>
                    Derivadas
                </button>
                <button id="filter-integral" class="filter-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" class="inline h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                      <path d="M12 4v1m0 14v1m-6.9-8.9l.7.7m12.5 0l.7-.7M5.6 18.4l.7-.7m12.5 0l.7.7" />
                    </svg>
                    Integrais
                </button>
            </div>

            <!-- Container da Lista de Histórico -->
            <div id="history-list-container" class="space-y-3">
                <!-- Conteúdo será gerado por JS -->
            </div>

            <!-- Placeholder de Histórico Vazio -->
            <div id="history-empty-placeholder" class="hidden text-center p-8">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center bg-blue-50 dark:bg-blue-900/50">
                    <svg class="w-8 h-8 text-blue-600 dark:text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.523 5.754 18 7.5 18s3.332.523 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.523 18.246 18 16.5 18c-1.746 0-3.332.523-4.5 1.253" />
                    </svg>
                </div>
                <p class="font-medium text-gray-800 dark:text-white mb-1">Nenhum cálculo no histórico</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Comece a calcular para ver seu histórico aqui.</p>
            </div>

        </div>

        <!-- NOVO: View de Opções -->
        <div id="options-view" class="hidden min-h-screen p-4 pt-4 space-y-4">
            
            <!-- Cartão de Tema (Adaptado de configurações.js) -->
            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-2 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                    </svg>
                    <h3 class="font-semibold text-lg text-gray-800 dark:text-white">Tema</h3>
                </div>
                <!-- Toggle de Modo Escuro Movido para cá -->
                <div class="flex items-center justify-between">
                    <span class="text-gray-700 dark:text-gray-300">Modo Escuro</span>
                    <button id="dark-mode-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-200 dark:bg-gray-600">
                        <span id="dark-mode-indicator" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1"></span>
                    </button>
                </div>
            </div>

            <!-- Cartão Sobre o App (Adaptado de configurações.js) -->
            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-2 mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h3 class="font-semibold text-lg text-gray-800 dark:text-white">Sobre o App</h3>
                </div>
                <p class="text-sm mb-3 text-gray-600 dark:text-gray-400">
                  DerivaIntegra é uma calculadora avançada para estudantes de ensino superior, 
                  com explicações passo a passo de derivadas e integrais.
                </p>
                <div class="p-3 rounded-lg space-y-2 bg-gray-50 dark:bg-gray-700/50">
                  <p class="text-xs font-semibold text-gray-700 dark:text-gray-200">✓ Derivadas com regras</p>
                  <p class="text-xs font-semibold text-gray-700 dark:text-gray-200">✓ Integrais definidas e indefinidas</p>
                  <p class="text-xs font-semibold text-gray-700 dark:text-gray-200">✓ Scanner de funções</p>
                  <p class="text-xs font-semibold text-gray-700 dark:text-gray-200">✓ Histórico completo</p>
                </div>
            </div>

        </div>
        
    </div>
    
    <!-- NOVO: Barra de Navegação Inferior (Adaptado do Layout.js) -->
    <nav class="fixed bottom-0 left-0 right-0 z-50 backdrop-blur-lg border-t bg-white/95 dark:bg-gray-800/95 border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-around px-2 py-2">
          <!-- Botão Calculadora -->
            <button id="nav-btn-calc" class="nav-btn active">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-10" fill="none" viewBox="-5 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 14h.01M9 10h.01M12 10h.01M15 10h.01M6 21h12a2 2 0 002-2V5a2 2 0 00-2-2H6a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
                <span class="text-xs font-medium w-full">Calculadora</span> <!-- ADICIONADO w-full -->
            </button>
            <!-- Botão Tutor (AGORA HISTÓRICO) -->
            <button id="nav-btn-history" class="nav-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-10" fill="none" viewBox="-5 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.523 5.754 18 7.5 18s3.332.523 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.523 18.246 18 16.5 18c-1.746 0-3.332.523-4.5 1.253" />
                </svg>
                <span class="text-xs font-medium w-full">Histórico</span> <!-- ADICIONADO w-full -->
            </button>
            <!-- Botão Menu (AGORA OPÇÕES) -->
            <button id="nav-btn-options" class="nav-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-10" fill="none" viewBox="-5 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span class="text-xs font-medium w-full">Opções</span> <!-- ADICIONADO w-full -->
            </button>
        </div>
    </nav>

    <!-- Menu Lateral (REMOVIDO) -->
    
    <!-- Modal de Scan -->
    <div id="scan-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div id="scan-modal-content" class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 w-full max-w-md space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white">Escanear Equação</h2>
                <button id="close-scan-modal-btn" class="text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="flex gap-2 p-1 bg-gray-100 dark:bg-gray-900 rounded-lg">
                <button id="upload-tab-btn" class="tab-btn active">Enviar Arquivo</button>
                <button id="camera-tab-btn" class="tab-btn">Usar Câmera</button>
            </div>
            <div id="upload-tab-content" class="tab-content active space-y-4">
                <input type="file" id="image-upload-input" accept="image/*" class="hidden">
                <button id="select-file-btn" class="w-full flex items-center justify-center gap-2 p-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                    <span>Clique para escolher um arquivo</span>
                </button>
                <div id="image-preview-container" class="w-full bg-gray-100 dark:bg-gray-700 rounded-lg min-h-[200px] flex items-center justify-center">
                    <img id="image-preview" src="" alt="Pré-visualização da imagem" class="hidden object-contain rounded-lg">
                    <p id="image-preview-placeholder" class="text-gray-500 dark:text-gray-400">Nenhuma imagem selecionada.</p>
                </div>
            </div>
            <div id="camera-tab-content" class="tab-content space-y-4">
                <div class="w-full bg-black rounded-lg min-h-[200px] flex items-center justify-center relative">
                    <video id="camera-stream" class="rounded-lg" autoplay playsinline></video>
                    <canvas id="camera-capture-canvas" class="hidden"></canvas>
                    <p id="camera-placeholder" class="hidden text-white">Não foi possível acessar a câmera.</p>
                </div>
                <button id="capture-btn" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    <span>Bater Foto</span>
                </button>
            </div>
            <div id="ocr-status" class="text-center text-gray-600 dark:text-gray-300 min-h-[50px]"></div>
            <div class="flex gap-4">
                <button id="recognize-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg btn-hover transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Reconhecer
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            window.addEventListener('load', startApp);
        });

        function startApp() {
            // DOM Elements
            const appContainer = document.getElementById('app-container');
            const loadingScreen = document.getElementById('loading-screen');
            const calculatorView = document.getElementById('calculator-view');
            const historyView = document.getElementById('history-view'); // RENOMEADO
            const optionsView = document.getElementById('options-view'); // NOVO
            
            // Elementos do Menu Lateral (REMOVIDOS)
            // const menuBtn = document.getElementById('menu-btn'); // REMOVIDO
            // const closeMenuBtn = document.getElementById('close-menu-btn'); // REMOVIDO
            // const sideMenu = document.getElementById('side-menu'); // REMOVIDO
            // const menuOverlay = document.getElementById('menu-overlay'); // REMOVIDO
            
            const darkModeToggle = document.getElementById('dark-mode-toggle'); // ID mantido
            const darkModeIndicator = document.getElementById('dark-mode-indicator'); // ID mantido
            
            const calculateBtn = document.getElementById('calculateBtn');
            const resultOutput = document.getElementById('resultOutput');
            const integralLimits = document.getElementById('integralLimits');
            const limitAInput = document.getElementById('limitA');
            const limitBInput = document.getElementById('limitB');
            const editorSpan = document.getElementById('equation-editor');
            const mathKeyboard = document.getElementById('mathKeyboard');
            
            // Elementos do Tutor REMOVIDOS
            
            // Scan Modal Elements
            const scanModal = document.getElementById('scan-modal');
            const closeScanModalBtn = document.getElementById('close-scan-modal-btn');
            const ocrStatus = document.getElementById('ocr-status');
            const recognizeBtn = document.getElementById('recognize-btn');
            const scanBtnHeader = document.getElementById('scan-btn-header'); // NOVO
            const functionDisplayText = document.getElementById('function-display-text'); // NOVO
            let selectedImageFile = null;
            let cameraStream = null;
            const uploadTabBtn = document.getElementById('upload-tab-btn');
            const cameraTabBtn = document.getElementById('camera-tab-btn');
            const uploadTabContent = document.getElementById('upload-tab-content');
            const cameraTabContent = document.getElementById('camera-tab-content');
            const imageUploadInput = document.getElementById('image-upload-input');
            const selectFileBtn = document.getElementById('select-file-btn');
            const imagePreview = document.getElementById('image-preview');
            const imagePreviewPlaceholder = document.getElementById('image-preview-placeholder');
            const cameraStreamEl = document.getElementById('camera-stream');
            const cameraCaptureCanvas = document.getElementById('camera-capture-canvas');
            const cameraPlaceholder = document.getElementById('camera-placeholder');
            const captureBtn = document.getElementById('capture-btn');

            // --- NOVO: Botões de Navegação Inferior ---
            const navBtnCalc = document.getElementById('nav-btn-calc');
            const navBtnHistory = document.getElementById('nav-btn-history'); // RENOMEADO
            const navBtnOptions = document.getElementById('nav-btn-options'); // RENOMEADO
            const navButtons = [navBtnCalc, navBtnHistory, navBtnOptions]; // ATUALIZADO
            
            // --- NOVO: Elementos da View de Histórico ---
            const historySearchInput = document.getElementById('history-search-input');
            const historyListContainer = document.getElementById('history-list-container');
            const historyEmptyPlaceholder = document.getElementById('history-empty-placeholder');
            const filterAllBtn = document.getElementById('filter-all');
            const filterDerivativeBtn = document.getElementById('filter-derivative');
            const filterIntegralBtn = document.getElementById('filter-integral');
            const filterButtons = [filterAllBtn, filterDerivativeBtn, filterIntegralBtn];
            
            // --- State ---
            // calculationHistory removido (agora é localStorage)
            let currentHistoryFilter = 'all'; // NOVO
            
            // --- Initialize MathQuill Editor ---
            const MQ = MathQuill.getInterface(2);
            const mathField = MQ.MathField(editorSpan, {
                spaceBehavesLikeTab: true,
                handlers: {
                    edit: () => updateFunctionDisplay() // NOVO: Atualiza o display ao digitar
                }
            });
            mathField.latex('sin(x)');

            // --- Helper Functions ---
            const cleanLatex = (latexStr) => latexStr.replace(/\\cdot/g, ' ');
            
            // updateHistory REMOVIDO

            // --- Keyboard Actions ---
            mathKeyboard.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const write = target.dataset.write;
                const cmd = target.dataset.cmd;
                const action = target.dataset.action;
                const value = target.dataset.value;
                mathField.focus();
                if (write) {
                    // CORREÇÃO: Sair automaticamente do bloco ao digitar operadores
                    if (['+', '-', '\cdot '].includes(write)) {
                        // 1. Envia "seta para a direita" para sair do expoente/fração
                        mathField.keystroke('Right');
                        // 2. Escreve o operador
                        mathField.write(write);
                    } else {
                        mathField.write(write);
                    }
                }
                else if (cmd) mathField.cmd(cmd);
                else if (action === 'keystroke') mathField.keystroke(value);
                else if (action === 'clear') mathField.latex('');
            });
            
            // Função para converter LaTeX para texto que o Nerdamer entende
            const latexToNerdamer = (latex) => {
                return latex
                    .replace(/\\sin/g, 'sin')
                    .replace(/\\cos/g, 'cos')
                    .replace(/\\tan/g, 'tan')
                    .replace(/\\ln/g, 'log')
                    .replace(/\\left\(/g, '(')
                    .replace(/\\right\)/g, ')')
                    .replace(/\\cdot/g, '*') // CORRIGIDO: Agora usa \cdot
                    .replace(/\\frac{([^}]+)}{([^}]+)}/g, '($1)/($2)')
                    .replace(/{/g, '')
                    .replace(/}/g, '');
            };

            // --- NOVO: Lógica da View de Histórico ---
            function getHistoryIcon(type) {
                if (type === 'derivative') {
                    return `<svg xmlns="http://www.w3.org/2000/svg" class="inline h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>`;
                }
                return `<svg xmlns="http://www.w3.org/2000/svg" class="inline h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /><path d="M12 4v1m0 14v1m-6.9-8.9l.7.7m12.5 0l.7-.7M5.6 18.4l.7-.7m12.5 0l.7.7" /></svg>`;
            }

            function formatHistoryDate(isoString) {
                return new Date(isoString).toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            function handleDeleteCalculation(id) {
                // MUDANÇA: Substituído confirm() por uma verificação simples, 
                // já que confirm() é bloqueado em alguns ambientes.
                // Para uma UI melhor, seria necessário um modal de confirmação customizado.
                console.log("Tentando excluir item:", id);
                let history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
                history = history.filter(item => item.id !== id);
                localStorage.setItem('calculationHistory', JSON.stringify(history));
                renderHistoryList(); // Re-renderiza a lista
            }

            function renderHistoryList() {
                const searchTerm = historySearchInput.value.toLowerCase();
                const history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');

                const filteredHistory = history.filter(item => {
                    // Filtro de Tipo
                    const typeMatch = currentHistoryFilter === 'all' || item.calculation_type === currentHistoryFilter;
                    // Filtro de Busca
                    const searchMatch = (item.original_function_latex || '').toLowerCase().includes(searchTerm) || 
                                      (item.result_latex || '').toLowerCase().includes(searchTerm);
                    return typeMatch && searchMatch;
                }).sort((a, b) => b.id - a.id); // Garante que os mais novos fiquem em cima

                if (filteredHistory.length === 0) {
                    historyListContainer.innerHTML = '';
                    historyEmptyPlaceholder.classList.remove('hidden');
                } else {
                    historyEmptyPlaceholder.classList.add('hidden');
                    historyListContainer.innerHTML = filteredHistory.map(item => `
                        <div class="history-card">
                            <div class="history-card-header">
                                <div class="history-card-icon">
                                    ${getHistoryIcon(item.calculation_type)}
                                </div>
                                <div class="history-card-fn">
                                    <!-- KaTeX renderizará aqui -->
                                    <div class="latex-input-render">${item.original_function_latex}</div>
                                </div>
                                <button class="delete-history-btn text-gray-400 hover:text-red-500" data-id="${item.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                            <div class="history-card-badges">
                                <span class="text-xs px-2 py-0.5 rounded-full bg-blue-50 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400 font-medium">
                                    ${item.calculation_type === 'derivative' ? 'Derivada' : 'Integral'}
                                </span>
                                <span class="text-xs px-2 py-0.5 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-medium">
                                    ${formatHistoryDate(item.created_date)}
                                </span>
                            </div>
                            <div class="history-card-result">
                                <img src="${item.result_image_url}" alt="Resultado do cálculo" />
                            </div>
                        </div>
                    `).join('');

                    // Renderiza KaTeX em todos os inputs
                    historyListContainer.querySelectorAll('.latex-input-render').forEach(el => {
                        katex.render(el.textContent, el, {
                            throwOnError: false,
                            displayMode: true
                        });
                    });

                    // Adiciona listeners aos botões de delete
                    historyListContainer.querySelectorAll('.delete-history-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            // Pede confirmação antes de deletar
                            if (confirm("Deseja realmente excluir este cálculo?")) {
                                handleDeleteCalculation(parseInt(btn.dataset.id));
                            }
                        });
                    });
                }
            }

            function updateFilterButtons(activeBtn) {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                activeBtn.classList.add('active');
            }

            // --- Lógica do Display de Função ---
            function updateFunctionDisplay() {
                try {
                    const latexInput = mathField.latex() || "f(x)";
                    const operation = document.querySelector('input[name="operation"]:checked').value;
                    const limitA = limitAInput.value;
                    const limitB = limitBInput.value;
                    
                    let finalLatex = '';

                    if (operation === 'derivative') {
                        finalLatex = `\\frac{d}{dx}\\left(${latexInput}\\right)`;
                    } else { // integral
                        if (limitA && limitB) {
                            finalLatex = `\\int_{${limitA}}^{${limitB}} ${latexInput} \\,dx`;
                        } else {
                            finalLatex = `\\int ${latexInput} \\,dx`;
                        }
                    }
                    
                    // Usar KaTeX (já importado no <head>) para renderizar
                    katex.render(finalLatex, functionDisplayText, {
                        throwOnError: false,
                        displayMode: true
                    });

                } catch (error) {
                    console.error("KaTeX Error:", error);
                    functionDisplayText.innerText = "Erro na formatação.";
                }
            }

            // --- Lógica da Calculadora ---
            const toggleIntegralLimits = () => {
                const selectedOperation = document.querySelector('input[name="operation"]:checked').value;
                const integralLimits = document.getElementById('integralLimits');
                integralLimits.classList.toggle('hidden', selectedOperation !== 'integral');
                updateFunctionDisplay(); // NOVO: Atualiza o display
            };

            const performCalculation = () => {
                try {
                    // MUDANÇA CRÍTICA: Usar .latex() e converter
                    const latexInput = mathField.latex();
                    if (!latexInput) {
                        resultOutput.innerHTML = `<p class="text-gray-500">Construa uma função.</p>`;
                        return;
                    }
                    const nerdamerInput = latexToNerdamer(latexInput);
                    
                    const expressionTex = cleanLatex(nerdamer(nerdamerInput).toTeX());
                    let finalLatex = '';
                    let calculationType = document.querySelector('input[name="operation"]:checked').value;

                    if (calculationType === 'derivative') {
                        const derivativeTex = cleanLatex(nerdamer.diff(nerdamerInput, 'x').toTeX());
                        finalLatex = `\\frac{d}{dx}\\left(${expressionTex}\\right) = ${derivativeTex}`;
                    } else {
                        const limitA = limitAInput.value, limitB = limitBInput.value;
                        if (limitA && limitB) {
                            calculationType = 'integral_defined'; // Tipo mais específico
                            const indefiniteIntegral = nerdamer.integrate(nerdamerInput, 'x');
                            const numA = parseFloat(limitA);
                            const numB = parseFloat(limitB);
                            const upperValStr = nerdamer(indefiniteIntegral.toString(), {x: numB}).evaluate().text('decimal');
                            const lowerValStr = nerdamer(indefiniteIntegral.toString(), {x: numA}).evaluate().text('decimal');
                            const integralVal = (parseFloat(upperValStr) - parseFloat(lowerValStr)).toFixed(4);
                            finalLatex = `\\int_{${limitA}}^{${limitB}} ${expressionTex} \\,dx = ${integralVal}`;
                        } else {
                            calculationType = 'integral_indefinite'; // Tipo mais específico
                            const integralTex = cleanLatex(nerdamer.integrate(nerdamerInput, 'x').toTeX());
                            finalLatex = `\\int ${expressionTex} \\,dx = ${integralTex} + C`;
                        }
                    }
                    resultOutput.innerHTML = `<p class="text-gray-500">A gerar imagem...</p>`;
                    const encodedLatex = encodeURIComponent(finalLatex);
                    const imageUrl = `https://latex.codecogs.com/svg.latex?${encodedLatex}`;
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = finalLatex;
                    img.onerror = () => resultOutput.innerHTML = `<p class="text-red-500">Erro ao carregar imagem.</p>`;
                    img.onload = () => {
                        resultOutput.innerHTML = '';
                        resultOutput.appendChild(img);
                        
                        // --- NOVO: Salva no localStorage ---
                        let history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
                        const newCalculation = {
                            id: Date.now(),
                            original_function_latex: latexInput,
                            original_function_nerdamer: nerdamerInput,
                            result_latex: finalLatex,
                            result_image_url: imageUrl,
                            calculation_type: document.querySelector('input[name="operation"]:checked').value, // Salva o tipo base
                            created_date: new Date().toISOString()
                        };
                        history.unshift(newCalculation); // Adiciona no início
                        localStorage.setItem('calculationHistory', JSON.stringify(history));
                        // --- Fim do Novo Bloco ---
                    };
                } catch (error) {
                    console.error("Calculation Error:", error);
                    resultOutput.innerHTML = `<p class="text-red-500">Função inválida.</p>`;
                }
            };
            
            // --- Lógica de Transição de Tela e Menu (Atualizada) ---
            
            // NOVO: Função para atualizar estado ativo dos botões
            const updateNavActiveState = (activeBtn) => {
                navButtons.forEach(btn => {
                    btn.classList.remove('active');
                });
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
            };

            const switchView = (viewToShow) => {
                const views = [calculatorView, historyView, optionsView]; // ATUALIZADO
                const targetView = document.getElementById(`${viewToShow}-view`);

                views.forEach(view => {
                    if (view !== targetView) {
                        view.style.opacity = '0';
                        setTimeout(() => view.classList.add('hidden'), 600);
                    }
                });

                targetView.classList.remove('hidden');
                setTimeout(() => {
                    targetView.style.opacity = '1';
                }, 20);

                // NOVO: Atualiza botões
                if (viewToShow === 'calculator') {
                    updateNavActiveState(navBtnCalc);
                } else if (viewToShow === 'history') { // ATUALIZADO
                    updateNavActiveState(navBtnHistory);
                    renderHistoryList(); // NOVO: Renderiza o histórico ao trocar para a view
                } else if (viewToShow === 'options') { // NOVO
                    updateNavActiveState(navBtnOptions);
                }
            };

            // Funções openMenu e closeMenu (REMOVIDAS)

            // Listeners do Menu (REMOVIDOS)
            // menuBtn.addEventListener('click', openMenu); 
            // closeMenuBtn.addEventListener('click', closeMenu);
            // menuOverlay.addEventListener('click', closeMenu);

            darkModeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                // NOVO: Sincroniza o indicador no modo escuro
                if (document.documentElement.classList.contains('dark')) {
                    darkModeIndicator.classList.add('translate-x-6');
                } else {
                    darkModeIndicator.classList.remove('translate-x-6');
                }
            });

            // --- Lógica do Tutor (REMOVIDA) ---

            // NOVO: Função reutilizável para abrir o histórico
            const openHistoryView = () => {
                switchView('history'); // A função switchView agora chama renderHistoryList
                // closeMenu() removido
            };
            
            // --- Lógica do Scanner de Equação (Restaurada) ---
            const stopCamera = () => {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                    cameraStreamEl.srcObject = null;
                }
            };

            const startCamera = async () => {
                stopCamera();
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('A API da câmera não é suportada neste navegador.');
                    }
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    cameraStreamEl.srcObject = cameraStream;
                    cameraPlaceholder.classList.add('hidden');
                    cameraStreamEl.classList.remove('hidden');
                    captureBtn.disabled = false;
                } catch (err) {
                    console.error("Erro ao acessar a câmera: ", err);
                    cameraPlaceholder.classList.remove('hidden');
                    cameraStreamEl.classList.add('hidden');
                    captureBtn.disabled = true;
                }
            };

            const switchTab = (tab) => {
                ocrStatus.innerHTML = '';
                recognizeBtn.disabled = true;
                selectedImageFile = null;
                if (tab === 'camera') {
                    uploadTabContent.classList.remove('active');
                    cameraTabContent.classList.add('active');
                    uploadTabBtn.classList.remove('active');
                    cameraTabBtn.classList.add('active');
                    startCamera();
                } else { // 'upload'
                    cameraTabContent.classList.remove('active');
                    uploadTabContent.classList.add('active');
                    cameraTabBtn.classList.remove('active');
                    uploadTabBtn.classList.add('active');
                    stopCamera();
                }
            };

            const openScanModal = () => {
                scanModal.classList.remove('hidden');
                switchTab('upload');
            };

            const closeScanModal = () => {
                scanModal.classList.add('hidden');
                stopCamera();
            };
            
            selectFileBtn.addEventListener('click', () => imageUploadInput.click());
            imageUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    selectedImageFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result; // CORRIGIDO AQUI
                        imagePreview.classList.remove('hidden');
                        imagePreviewPlaceholder.classList.add('hidden');
                        recognizeBtn.disabled = false;
                    };
                    reader.readAsDataURL(file);
                }
                event.target.value = '';
            });

            captureBtn.addEventListener('click', () => {
                if (!cameraStream) return;
                const context = cameraCaptureCanvas.getContext('2d');
                cameraCaptureCanvas.width = cameraStreamEl.videoWidth;
                cameraCaptureCanvas.height = cameraStreamEl.videoHeight;
                context.drawImage(cameraStreamEl, 0, 0, cameraCaptureCanvas.width, cameraCaptureCanvas.height);
                
                imagePreview.src = cameraCaptureCanvas.toDataURL('image/png');
                imagePreview.classList.remove('hidden');
                imagePreviewPlaceholder.classList.add('hidden');
                
                cameraCaptureCanvas.toBlob(blob => {
                    selectedImageFile = blob;
                });
                
                recognizeBtn.disabled = false;
                switchTab('upload');
            });

            recognizeBtn.addEventListener('click', async () => {
                if (!selectedImageFile) return;

                ocrStatus.innerHTML = 'Inicializando o motor de OCR...';
                recognizeBtn.disabled = true;

                const worker = await Tesseract.createWorker('eng', 1, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            ocrStatus.innerHTML = `Reconhecendo... (${Math.round(m.progress * 100)}%)`;
                        } else {
                            ocrStatus.innerHTML = `Processando: ${m.status}`;
                        }
                    },
                });

                try {
                    const { data: { text } } = await worker.recognize(selectedImageFile);
                    ocrStatus.innerHTML = `<strong>Equação Reconhecida:</strong><br><code class="bg-gray-200 dark:bg-gray-600 p-1 rounded">${text}</code>`;
                    
                    const latexText = text
                        .replace(/\*/g, '\\cdot ')
                        .replace(/\//g, '\\frac')
                        .replace(/÷/g, '\\frac') // CORRIGIDO
                        .replace(/\n/g, ' ');
                    mathField.latex(latexText);
                    
                    await worker.terminate();
                    setTimeout(closeScanModal, 2000);
                } catch (error) {
                    console.error('Erro no OCR:', error);
                    ocrStatus.innerHTML = '<span class="text-red-500">Não foi possível reconhecer a equação.</span>';
                    await worker.terminate();
                } finally {
                    recognizeBtn.disabled = false;
                }
            });

            uploadTabBtn.addEventListener('click', () => switchTab('upload'));
            cameraTabBtn.addEventListener('click', () => switchTab('camera'));
            closeScanModalBtn.addEventListener('click', closeScanModal);

            // --- Attach Listeners ---
            calculateBtn.addEventListener('click', performCalculation);
            document.querySelectorAll('input[name="operation"]').forEach(radio => radio.addEventListener('change', toggleIntegralLimits));
            limitAInput.addEventListener('input', updateFunctionDisplay); // NOVO
            limitBInput.addEventListener('input', updateFunctionDisplay); // NOVO
            scanBtnHeader.addEventListener('click', openScanModal); // NOVO
            // NOVO: Clicar no display foca o editor escondido
            document.getElementById('function-display-area').addEventListener('click', () => {
                mathField.focus();
            });

            // --- NOVO: Listeners da Navegação Inferior ---
            navBtnCalc.addEventListener('click', () => switchView('calculator'));
            navBtnHistory.addEventListener('click', openHistoryView); // ATUALIZADO
            navBtnOptions.addEventListener('click', () => switchView('options')); // NOVO

            // --- NOVO: Listeners dos Filtros de Histórico ---
            historySearchInput.addEventListener('input', renderHistoryList);
            
            filterAllBtn.addEventListener('click', () => {
                currentHistoryFilter = 'all';
                updateFilterButtons(filterAllBtn);
                renderHistoryList();
            });
            filterDerivativeBtn.addEventListener('click', () => {
                currentHistoryFilter = 'derivative';
                updateFilterButtons(filterDerivativeBtn);
                renderHistoryList();
            });
            filterIntegralBtn.addEventListener('click', () => {
                currentHistoryFilter = 'integral';
                updateFilterButtons(filterIntegralBtn);
                renderHistoryList();
            });


            // --- App Final Initialization ---
            appContainer.style.display = 'block';
            setTimeout(() => {
                loadingScreen.style.opacity = '0';
                appContainer.style.opacity = '1';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }, 10);
            
            // NOVO: Sincroniza o toggle do modo escuro ao iniciar
            if (document.documentElement.classList.contains('dark')) {
                darkModeIndicator.classList.add('translate-x-6');
            }

            mathField.focus(); // NOVO: Foca o editor ao iniciar
            updateFunctionDisplay(); // NOVO: Chamada inicial
            resultOutput.innerHTML = `<p class="text-gray-500 dark:text-gray-400">Construa uma função e clique em "Calcular".</p>`;
        };
    </script>

</body>
</html>